AWSTemplateFormatVersion: '2010-09-09'
Description: 'CloudFormation template for Urban Transportation Optimization Platform with integrated AWS services for geospatial analysis, real-time traffic data processing, and SUMO simulations'

Parameters:
  ProjectName:
    Type: String
    Default: transportation-optimization
    Description: Name of the project
    MinLength: 1
    MaxLength: 50

  PostGISInstanceClass:
    Type: String
    Default: db.r5.xlarge
    AllowedValues:
      - db.r5.large
      - db.r5.xlarge
      - db.r5.2xlarge
      - db.r6i.xlarge
      - db.r6i.2xlarge
    Description: RDS instance class for PostGIS database

  NeptuneInstanceClass:
    Type: String
    Default: db.r5.large
    AllowedValues:
      - db.r5.large
      - db.r5.xlarge
      - db.r6i.large
      - db.r6i.xlarge
    Description: Neptune instance class for graph database

  BatchMaxvCpus:
    Type: Number
    Default: 256
    MinValue: 4
    MaxValue: 1024
    Description: Maximum number of vCPUs for AWS Batch compute environment

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Project Configuration
        Parameters:
          - ProjectName
      - Label:
          default: Database Configuration
        Parameters:
          - PostGISInstanceClass
          - NeptuneInstanceClass
      - Label:
          default: Batch Configuration
        Parameters:
          - BatchMaxvCpus

Resources:
  # ==================== VPC Infrastructure ====================
  TransportationVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-vpc'

  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref TransportationVPC
      CidrBlock: 10.0.1.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-public-subnet-1'

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref TransportationVPC
      CidrBlock: 10.0.2.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-public-subnet-2'

  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref TransportationVPC
      CidrBlock: 10.0.11.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-private-subnet-1'

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref TransportationVPC
      CidrBlock: 10.0.12.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-private-subnet-2'

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-igw'

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref TransportationVPC
      InternetGatewayId: !Ref InternetGateway

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref TransportationVPC
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-public-rt'

  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet1
      RouteTableId: !Ref PublicRouteTable

  PublicSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet2
      RouteTableId: !Ref PublicRouteTable

  NATGatewayEIP:
    Type: AWS::EC2::EIP
    DependsOn: AttachGateway
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-nat-eip'

  NATGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NATGatewayEIP.AllocationId
      SubnetId: !Ref PublicSubnet1
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-nat-gateway'

  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref TransportationVPC
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-private-rt'

  PrivateRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NATGateway

  PrivateSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet1
      RouteTableId: !Ref PrivateRouteTable

  PrivateSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet2
      RouteTableId: !Ref PrivateRouteTable

  S3VPCEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref TransportationVPC
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.s3'
      RouteTableIds:
        - !Ref PrivateRouteTable
        - !Ref PublicRouteTable

  # ==================== Security Groups ====================
  PostGISSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for PostGIS RDS
      VpcId: !Ref TransportationVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          SourceSecurityGroupId: !Ref LambdaSecurityGroup
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          SourceSecurityGroupId: !Ref BatchSecurityGroup
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-postgis-sg'

  NeptuneSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Neptune
      VpcId: !Ref TransportationVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 8182
          ToPort: 8182
          SourceSecurityGroupId: !Ref LambdaSecurityGroup
        - IpProtocol: tcp
          FromPort: 8182
          ToPort: 8182
          SourceSecurityGroupId: !Ref BatchSecurityGroup
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-neptune-sg'

  LambdaSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Lambda functions
      VpcId: !Ref TransportationVPC
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-lambda-sg'

  BatchSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for AWS Batch
      VpcId: !Ref TransportationVPC
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-batch-sg'

  # ==================== S3 Buckets ====================
  RoadNetworksBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${ProjectName}-road-networks-${AWS::AccountId}'
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-road-networks'

  GTFSDataBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${ProjectName}-gtfs-data-${AWS::AccountId}'
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-gtfs-data'

  GPSTracesBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${ProjectName}-gps-traces-${AWS::AccountId}'
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-gps-traces'

  ModelsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${ProjectName}-models-${AWS::AccountId}'
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-models'

  SimulationResultsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${ProjectName}-simulation-results-${AWS::AccountId}'
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-simulation-results'

  # ==================== Kinesis Streams ====================
  TrafficSensorStream:
    Type: AWS::Kinesis::Stream
    Properties:
      Name: !Sub '${ProjectName}-traffic-sensor-stream'
      StreamModeDetails:
        StreamMode: ON_DEMAND
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-traffic-sensor'

  TransitVehicleStream:
    Type: AWS::Kinesis::Stream
    Properties:
      Name: !Sub '${ProjectName}-transit-vehicle-stream'
      StreamModeDetails:
        StreamMode: ON_DEMAND
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-transit-vehicle'

  # ==================== RDS PostGIS ====================
  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Subnet group for transportation database
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-db-subnet-group'

  TransportationDatabase:
    Type: AWS::RDS::DBInstance
    DeletionPolicy: Snapshot
    Properties:
      DBInstanceIdentifier: !Sub '${ProjectName}-postgis-db'
      Engine: postgres
      EngineVersion: '15.3'
      DBInstanceClass: !Ref PostGISInstanceClass
      AllocatedStorage: '200'
      StorageType: gp3
      StorageEncrypted: true
      DBSubnetGroupName: !Ref DBSubnetGroup
      VPCSecurityGroups:
        - !Ref PostGISSecurityGroup
      MasterUsername: admin
      MasterUserPassword: !Sub 'Password${ProjectName}2024!'
      MultiAZ: true
      BackupRetentionPeriod: 30
      PreferredBackupWindow: '03:00-04:00'
      PreferredMaintenanceWindow: 'mon:04:00-mon:05:00'
      EnableCloudwatchLogsExports:
        - postgresql
      DeleteDBInstanceAutomatedBackups: false
      CopyTagsToSnapshot: true
      EnableIAMDatabaseAuthentication: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-postgis'

  PostGISExtension:
    Type: AWS::RDS::DBInstanceParameterGroupAssociation
    Properties:
      DBInstanceIdentifier: !Ref TransportationDatabase
      DBParameterGroupName: !Ref PostGISParameterGroup

  PostGISParameterGroup:
    Type: AWS::RDS::DBParameterGroup
    Properties:
      Family: postgres15
      Description: Parameter group for PostGIS
      Parameters:
        shared_preload_libraries: 'postgis'
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-postgis-params'

  # ==================== Neptune Graph Database ====================
  NeptuneSubnetGroup:
    Type: AWS::Neptune::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Subnet group for Neptune
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-neptune-subnet-group'

  NeptuneParameterGroup:
    Type: AWS::Neptune::DBParameterGroup
    Properties:
      Description: Parameter group for Neptune
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-neptune-params'

  NeptuneCluster:
    Type: AWS::Neptune::DBCluster
    Properties:
      DBClusterIdentifier: !Sub '${ProjectName}-neptune-cluster'
      IamAuthEnabled: true
      StorageEncrypted: true
      DBSubnetGroupName: !Ref NeptuneSubnetGroup
      VpcSecurityGroupIds:
        - !Ref NeptuneSecurityGroup
      BackupRetentionPeriod: 7
      PreferredBackupWindow: '03:00-04:00'
      PreferredMaintenanceWindow: 'mon:04:00-mon:05:00'
      EnableLogExports:
        - neptune
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-neptune'

  NeptuneInstance1:
    Type: AWS::Neptune::DBInstance
    Properties:
      DBInstanceIdentifier: !Sub '${ProjectName}-neptune-instance-1'
      DBInstanceClass: !Ref NeptuneInstanceClass
      DBClusterIdentifier: !Ref NeptuneCluster
      AutoMinorVersionUpgrade: true

  NeptuneInstance2:
    Type: AWS::Neptune::DBInstance
    Properties:
      DBInstanceIdentifier: !Sub '${ProjectName}-neptune-instance-2'
      DBInstanceClass: !Ref NeptuneInstanceClass
      DBClusterIdentifier: !Ref NeptuneCluster
      AutoMinorVersionUpgrade: true

  # ==================== Timestream ====================
  TimestreamDatabase:
    Type: AWS::Timestream::Database
    Properties:
      DatabaseName: !Sub '${ProjectName}-traffic-db'
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-timestream-db'

  TimestreamTable:
    Type: AWS::Timestream::Table
    Properties:
      DatabaseName: !Ref TimestreamDatabase
      TableName: traffic-sensor-data
      RetentionProperties:
        MemoryStoreRetentionPeriodInHours: 12
        MagneticStoreRetentionPeriodInDays: 365
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-timestream-table'

  # ==================== Lambda Execution Role ====================
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-lambda-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
      Policies:
        - PolicyName: S3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:ListBucket
                Resource:
                  - !GetAtt GTFSDataBucket.Arn
                  - !Sub '${GTFSDataBucket.Arn}/*'
                  - !GetAtt ModelsBucket.Arn
                  - !Sub '${ModelsBucket.Arn}/*'
        - PolicyName: KinesisAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - kinesis:GetRecords
                  - kinesis:GetShardIterator
                  - kinesis:DescribeStream
                  - kinesis:ListStreams
                  - kinesis:ListShards
                  - kinesis:ListStreamConsumers
                Resource:
                  - !GetAtt TrafficSensorStream.Arn
                  - !GetAtt TransitVehicleStream.Arn
        - PolicyName: RDSAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - rds-db:connect
                Resource: !Sub 'arn:aws:rds:${AWS::Region}:${AWS::AccountId}:db/*'
        - PolicyName: NeptuneAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - neptune-db:connect
                Resource: !Sub 'arn:aws:neptune-db:${AWS::Region}:${AWS::AccountId}:cluster/*'
        - PolicyName: TimestreamAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - timestream:WriteRecords
                  - timestream:DescribeDatabase
                  - timestream:DescribeTable
                Resource: !GetAtt TimestreamTable.Arn
        - PolicyName: CloudWatchLogs
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:*'

  # ==================== Lambda Functions ====================
  GTFSIngestionFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-gtfs-ingest'
      Runtime: python3.11
      Role: !GetAtt LambdaExecutionRole.Arn
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
      Timeout: 300
      MemorySize: 512
      Code:
        ZipFile: |
          import json
          import boto3
          import logging

          logger = logging.getLogger()
          logger.setLevel(logging.INFO)

          s3_client = boto3.client('s3')

          def lambda_handler(event, context):
              logger.info('GTFS Ingestion started')
              try:
                  # Placeholder for GTFS processing logic
                  return {
                      'statusCode': 200,
                      'body': json.dumps('GTFS data ingestion completed')
                  }
              except Exception as e:
                  logger.error(f'Error: {str(e)}')
                  return {
                      'statusCode': 500,
                      'body': json.dumps(f'Error: {str(e)}')
                  }
      Environment:
        Variables:
          GTFS_BUCKET: !Ref GTFSDataBucket

  TrafficDataProcessorFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-traffic-processor'
      Runtime: python3.11
      Role: !GetAtt LambdaExecutionRole.Arn
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
      Timeout: 60
      MemorySize: 512
      Code:
        ZipFile: |
          import json
          import boto3
          import logging
          import base64

          logger = logging.getLogger()
          logger.setLevel(logging.INFO)

          timestream = boto3.client('timestream-write')

          def lambda_handler(event, context):
              logger.info('Traffic data processing started')
              try:
                  for record in event['Records']:
                      payload = base64.b64decode(record['kinesis']['data'])
                      data = json.loads(payload)
                      logger.info(f'Processing record: {data}')

                  return {
                      'statusCode': 200,
                      'body': json.dumps('Traffic data processed')
                  }
              except Exception as e:
                  logger.error(f'Error: {str(e)}')
                  return {
                      'statusCode': 500,
                      'body': json.dumps(f'Error: {str(e)}')
                  }
      Environment:
        Variables:
          TIMESTREAM_DATABASE: !Ref TimestreamDatabase

  TrafficPredictionFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-traffic-prediction'
      Runtime: python3.11
      Role: !GetAtt LambdaExecutionRole.Arn
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
      Timeout: 120
      MemorySize: 1024
      Code:
        ZipFile: |
          import json
          import boto3
          import logging

          logger = logging.getLogger()
          logger.setLevel(logging.INFO)

          s3_client = boto3.client('s3')

          def lambda_handler(event, context):
              logger.info('Traffic prediction inference started')
              try:
                  # Placeholder for ML inference logic
                  return {
                      'statusCode': 200,
                      'body': json.dumps('Traffic prediction completed')
                  }
              except Exception as e:
                  logger.error(f'Error: {str(e)}')
                  return {
                      'statusCode': 500,
                      'body': json.dumps(f'Error: {str(e)}')
                  }
      Environment:
        Variables:
          MODELS_BUCKET: !Ref ModelsBucket

  TrafficDataProcessorEventSourceMapping:
    Type: AWS::Lambda::EventSourceMapping
    Properties:
      EventSourceArn: !GetAtt TrafficSensorStream.Arn
      FunctionName: !Ref TrafficDataProcessorFunction
      Enabled: true
      BatchSize: 100
      StartingPosition: LATEST

  GTFSIngestionScheduleRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: InvokeLambda
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action: lambda:InvokeFunction
                Resource: !GetAtt GTFSIngestionFunction.Arn

  GTFSIngestionSchedule:
    Type: AWS::Events::Rule
    Properties:
      Name: !Sub '${ProjectName}-gtfs-daily-schedule'
      ScheduleExpression: cron(0 2 * * ? *)
      State: ENABLED
      Targets:
        - Arn: !GetAtt GTFSIngestionFunction.Arn
          RoleArn: !GetAtt GTFSIngestionScheduleRole.Arn
          Id: GTFSIngestionTarget

  GTFSIngestionLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref GTFSIngestionFunction
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt GTFSIngestionSchedule.Arn

  # ==================== SageMaker Execution Role ====================
  SageMakerExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-sagemaker-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: sagemaker.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSageMakerFullAccess
      Policies:
        - PolicyName: S3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                  - s3:ListBucket
                Resource:
                  - !GetAtt ModelsBucket.Arn
                  - !Sub '${ModelsBucket.Arn}/*'
                  - !GetAtt GPSTracesBucket.Arn
                  - !Sub '${GPSTracesBucket.Arn}/*'
        - PolicyName: DatabaseAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - rds-db:connect
                Resource: !Sub 'arn:aws:rds:${AWS::Region}:${AWS::AccountId}:db/*'
              - Effect: Allow
                Action:
                  - neptune-db:connect
                Resource: !Sub 'arn:aws:neptune-db:${AWS::Region}:${AWS::AccountId}:cluster/*'

  # ==================== AWS Batch ====================
  BatchServiceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-batch-service-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: batch.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSBatchServiceRole

  BatchInstanceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-batch-instance-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonEC2ContainerServiceforEC2Role
      Policies:
        - PolicyName: S3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:ListBucket
                Resource:
                  - !GetAtt RoadNetworksBucket.Arn
                  - !Sub '${RoadNetworksBucket.Arn}/*'
                  - !GetAtt SimulationResultsBucket.Arn
                  - !Sub '${SimulationResultsBucket.Arn}/*'
        - PolicyName: DatabaseAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - rds-db:connect
                Resource: !Sub 'arn:aws:rds:${AWS::Region}:${AWS::AccountId}:db/*'

  BatchInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref BatchInstanceRole

  BatchComputeEnvironment:
    Type: AWS::Batch::ComputeEnvironment
    Properties:
      ComputeEnvironmentName: !Sub '${ProjectName}-compute-env'
      Type: MANAGED
      ServiceRole: !GetAtt BatchServiceRole.Arn
      ComputeResources:
        Type: EC2
        AllocationStrategy: SPOT_CAPACITY_OPTIMIZED
        MinvCpus: 0
        MaxvCpus: !Ref BatchMaxvCpus
        DesiredvCpus: 0
        InstanceTypes:
          - c5.large
          - c5.xlarge
          - c5.2xlarge
          - c5a.large
          - c5a.xlarge
        Subnets:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
        SecurityGroupIds:
          - !Ref BatchSecurityGroup
        InstanceRole: !GetAtt BatchInstanceProfile.Arn
        SpotIamFleetRole: !GetAtt BatchSpotFleetRole.Arn
        Tags:
          Name: !Sub '${ProjectName}-batch-instance'

  BatchSpotFleetRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-batch-spot-fleet-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: spotfleet.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonEC2SpotFleetServiceRole

  BatchJobQueue:
    Type: AWS::Batch::JobQueue
    Properties:
      JobQueueName: !Sub '${ProjectName}-job-queue'
      State: ENABLED
      Priority: 1
      ComputeEnvironmentOrder:
        - Order: 1
          ComputeEnvironment: !Ref BatchComputeEnvironment

  BatchJobDefinition:
    Type: AWS::Batch::JobDefinition
    Properties:
      JobDefinitionName: !Sub '${ProjectName}-sumo-simulation'
      Type: container
      ContainerProperties:
        Image: !Sub '${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/sumo-simulator:latest'
        Vcpus: 4
        Memory: 8192
        Environment:
          - Name: S3_OUTPUT_BUCKET
            Value: !Ref SimulationResultsBucket
          - Name: S3_ROAD_NETWORKS_BUCKET
            Value: !Ref RoadNetworksBucket

  # ==================== AWS Glue ====================
  GlueDatabase:
    Type: AWS::Glue::Database
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseInput:
        Name: !Sub '${ProjectName}-data-catalog'
        Description: Data catalog for transportation optimization

  GlueCrawler:
    Type: AWS::Glue::Crawler
    Properties:
      Name: !Sub '${ProjectName}-gps-crawler'
      Role: !GetAtt GlueExecutionRole.Arn
      DatabaseName: !Ref GlueDatabase
      Targets:
        S3Targets:
          - Path: !Sub 's3://${GPSTracesBucket}/'
      SchemaChangePolicy:
        UpdateBehavior: UPDATE_IN_DATABASE
        DeleteBehavior: LOG

  GlueExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-glue-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: glue.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSGlueServiceRole
      Policies:
        - PolicyName: S3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:ListBucket
                Resource:
                  - !GetAtt GPSTracesBucket.Arn
                  - !Sub '${GPSTracesBucket.Arn}/*'

  GlueETLJob:
    Type: AWS::Glue::Job
    Properties:
      Name: !Sub '${ProjectName}-gps-transform'
      Role: !GetAtt GlueExecutionRole.Arn
      Command:
        Name: glueetl
        ScriptLocation: !Sub 's3://${GTFSDataBucket}/scripts/gps_transform.py'
      DefaultArguments:
        '--job-bookmark-option': job-bookmark-enable
      GlueVersion: '4.0'
      MaxRetries: 1
      Timeout: 2880

  # ==================== Athena ====================
  AthenaWorkgroup:
    Type: AWS::Athena::WorkGroup
    Properties:
      Name: !Sub '${ProjectName}-workgroup'
      RecursiveDeleteOption: true
      State: ENABLED
      WorkGroupConfiguration:
        ResultConfigurationUpdates:
          OutputLocation: !Sub 's3://${GPSTracesBucket}/athena-results/'
        EnforceWorkGroupConfiguration: true
        PublishCloudWatchMetricsEnabled: true

  # ==================== QuickSight ====================
  QuickSightServiceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-quicksight-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: quicksight.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: S3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:ListBucket
                Resource:
                  - !GetAtt SimulationResultsBucket.Arn
                  - !Sub '${SimulationResultsBucket.Arn}/*'
                  - !GetAtt GPSTracesBucket.Arn
                  - !Sub '${GPSTracesBucket.Arn}/*'
        - PolicyName: AthenaAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - athena:StartQueryExecution
                  - athena:GetQueryExecution
                  - athena:GetQueryResults
                Resource: '*'

Outputs:
  VPCId:
    Description: VPC ID
    Value: !Ref TransportationVPC
    Export:
      Name: !Sub '${ProjectName}-vpc-id'

  RoadNetworksBucketName:
    Description: S3 bucket for road networks data
    Value: !Ref RoadNetworksBucket
    Export:
      Name: !Sub '${ProjectName}-road-networks-bucket'

  GTFSDataBucketName:
    Description: S3 bucket for GTFS data
    Value: !Ref GTFSDataBucket
    Export:
      Name: !Sub '${ProjectName}-gtfs-bucket'

  GPSTracesBucketName:
    Description: S3 bucket for GPS traces
    Value: !Ref GPSTracesBucket
    Export:
      Name: !Sub '${ProjectName}-gps-traces-bucket'

  ModelsBucketName:
    Description: S3 bucket for ML models
    Value: !Ref ModelsBucket
    Export:
      Name: !Sub '${ProjectName}-models-bucket'

  SimulationResultsBucketName:
    Description: S3 bucket for simulation results
    Value: !Ref SimulationResultsBucket
    Export:
      Name: !Sub '${ProjectName}-simulation-results-bucket'

  TrafficSensorStreamName:
    Description: Kinesis stream for traffic sensor data
    Value: !Ref TrafficSensorStream
    Export:
      Name: !Sub '${ProjectName}-traffic-sensor-stream'

  TransitVehicleStreamName:
    Description: Kinesis stream for transit vehicle data
    Value: !Ref TransitVehicleStream
    Export:
      Name: !Sub '${ProjectName}-transit-vehicle-stream'

  PostGISEndpoint:
    Description: RDS PostGIS endpoint
    Value: !GetAtt TransportationDatabase.Endpoint.Address
    Export:
      Name: !Sub '${ProjectName}-postgis-endpoint'

  NeptuneClusterEndpoint:
    Description: Neptune cluster endpoint
    Value: !GetAtt NeptuneCluster.ClusterResourceId
    Export:
      Name: !Sub '${ProjectName}-neptune-endpoint'

  TimestreamDatabaseName:
    Description: Timestream database name
    Value: !Ref TimestreamDatabase
    Export:
      Name: !Sub '${ProjectName}-timestream-db'

  GTFSIngestionFunctionArn:
    Description: ARN of GTFS ingestion Lambda function
    Value: !GetAtt GTFSIngestionFunction.Arn
    Export:
      Name: !Sub '${ProjectName}-gtfs-function-arn'

  TrafficProcessorFunctionArn:
    Description: ARN of traffic processor Lambda function
    Value: !GetAtt TrafficDataProcessorFunction.Arn
    Export:
      Name: !Sub '${ProjectName}-traffic-processor-arn'

  BatchJobQueueName:
    Description: AWS Batch job queue name
    Value: !Ref BatchJobQueue
    Export:
      Name: !Sub '${ProjectName}-batch-queue'

  GlueDatabaseName:
    Description: Glue database name
    Value: !Ref GlueDatabase
    Export:
      Name: !Sub '${ProjectName}-glue-database'

  AthenaWorkgroupName:
    Description: Athena workgroup name
    Value: !Ref AthenaWorkgroup
    Export:
      Name: !Sub '${ProjectName}-athena-workgroup'
