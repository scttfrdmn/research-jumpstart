AWSTemplateFormatVersion: '2010-09-09'
Description: 'CloudFormation template for comprehensive archaeology site analysis infrastructure with LiDAR processing, artifact classification, and geospatial database'

Parameters:
  ProjectName:
    Type: String
    Default: archaeology-site-analysis
    Description: Project name for resource naming
    MinLength: 1
    MaxLength: 64

  PostGISInstanceClass:
    Type: String
    Default: db.t3.large
    Description: RDS instance class for PostGIS database
    AllowedValues:
      - db.t3.large
      - db.t3.xlarge
      - db.t4g.large
      - db.r5.large
      - db.r5.xlarge

  GPUInstanceType:
    Type: String
    Default: g4dn.xlarge
    Description: EC2 GPU instance type for photogrammetry and deep learning
    AllowedValues:
      - g4dn.xlarge
      - g4dn.2xlarge
      - g4dn.12xlarge

  EnvironmentTag:
    Type: String
    Default: development
    Description: Environment tag for resources
    AllowedValues:
      - development
      - staging
      - production

Mappings:
  RegionMap:
    us-east-1:
      AMI: ami-0c55b159cbfafe1f0
    us-west-2:
      AMI: ami-0d1cd67c26f5fca19
    eu-west-1:
      AMI: ami-0dad359ff462124ca

Resources:
  # ==================== VPC Infrastructure ====================
  ArchaeologyVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-vpc'
        - Key: Environment
          Value: !Ref EnvironmentTag

  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref ArchaeologyVPC
      CidrBlock: 10.0.1.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-public-subnet-1'

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref ArchaeologyVPC
      CidrBlock: 10.0.2.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-public-subnet-2'

  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref ArchaeologyVPC
      CidrBlock: 10.0.10.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-private-subnet-1'

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref ArchaeologyVPC
      CidrBlock: 10.0.11.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-private-subnet-2'

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-igw'

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref ArchaeologyVPC
      InternetGatewayId: !Ref InternetGateway

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref ArchaeologyVPC
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-public-rt'

  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  SubnetRouteTableAssociation1:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet1
      RouteTableId: !Ref PublicRouteTable

  SubnetRouteTableAssociation2:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet2
      RouteTableId: !Ref PublicRouteTable

  ElasticIP:
    Type: AWS::EC2::EIP
    DependsOn: AttachGateway
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-eip'

  NATGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt ElasticIP.AllocationId
      SubnetId: !Ref PublicSubnet1
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-nat'

  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref ArchaeologyVPC
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-private-rt'

  PrivateRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NATGateway

  PrivateSubnetRouteTableAssociation1:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet1
      RouteTableId: !Ref PrivateRouteTable

  PrivateSubnetRouteTableAssociation2:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet2
      RouteTableId: !Ref PrivateRouteTable

  S3VPCEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref ArchaeologyVPC
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.s3'
      RouteTableIds:
        - !Ref PrivateRouteTable
        - !Ref PublicRouteTable

  # ==================== Security Groups ====================
  PostGISSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for PostGIS RDS database
      VpcId: !Ref ArchaeologyVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          CidrIp: 10.0.0.0/16
          Description: PostgreSQL from VPC
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-postgis-sg'

  EC2SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for EC2 GPU instances
      VpcId: !Ref ArchaeologyVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 10.0.0.0/16
          Description: SSH from VPC
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: HTTPS for AWS API access
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-ec2-sg'

  BatchSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for AWS Batch compute environment
      VpcId: !Ref ArchaeologyVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: HTTPS for AWS services
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-batch-sg'

  # ==================== S3 Buckets ====================
  LiDARDataBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${ProjectName}-lidar-data-${AWS::AccountId}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-lidar'
        - Key: DataType
          Value: LiDAR Point Clouds

  ArtifactImagesBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${ProjectName}-artifact-images-${AWS::AccountId}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-artifact-images'
        - Key: DataType
          Value: Artifact Photography

  GISDataBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${ProjectName}-gis-data-${AWS::AccountId}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-gis-data'
        - Key: DataType
          Value: GIS Shapefiles and GeoTIFFs

  ModelsDataBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${ProjectName}-3d-models-${AWS::AccountId}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-3d-models'
        - Key: DataType
          Value: Photogrammetry 3D Models

  ResultsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${ProjectName}-results-${AWS::AccountId}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-results'
        - Key: DataType
          Value: Analysis Results and Outputs

  # ==================== RDS PostgreSQL with PostGIS ====================
  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Subnet group for RDS PostGIS database
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-db-subnet-group'

  PostGISDatabase:
    Type: AWS::RDS::DBInstance
    DeletionPolicy: Snapshot
    Properties:
      DBInstanceIdentifier: !Sub '${ProjectName}-postgis-db'
      Engine: postgres
      EngineVersion: '14.7'
      DBInstanceClass: !Ref PostGISInstanceClass
      AllocatedStorage: '100'
      StorageType: gp3
      StorageEncrypted: true
      DBName: archaeology
      MasterUsername: postgresadmin
      MasterUserPassword: !Sub '{{resolve:secretsmanager:${ProjectName}-db-password:SecretString:password}}'
      VPCSecurityGroups:
        - !Ref PostGISSecurityGroup
      DBSubnetGroupName: !Ref DBSubnetGroup
      MultiAZ: true
      BackupRetentionPeriod: 30
      PreferredBackupWindow: '03:00-04:00'
      PreferredMaintenanceWindow: 'sun:04:00-sun:05:00'
      EnableCloudwatchLogsExports:
        - postgresql
      EnableIAMDatabaseAuthentication: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-postgis'
        - Key: Environment
          Value: !Ref EnvironmentTag

  PostGISExtension:
    Type: AWS::RDS::DBClusterParameterGroup
    Properties:
      Description: Parameter group with PostGIS extension
      Family: postgres14
      Parameters:
        shared_preload_libraries: 'pg_stat_statements,pgaudit'
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-postgis-param-group'

  # ==================== EC2 GPU Launch Template ====================
  GPULaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: !Sub '${ProjectName}-gpu-template'
      LaunchTemplateData:
        ImageId: !FindInMap [RegionMap, !Ref 'AWS::Region', AMI]
        InstanceType: !Ref GPUInstanceType
        SecurityGroupIds:
          - !Ref EC2SecurityGroup
        TagSpecifications:
          - ResourceType: instance
            Tags:
              - Key: Name
                Value: !Sub '${ProjectName}-gpu-instance'
              - Key: Environment
                Value: !Ref EnvironmentTag
        UserData:
          Fn::Base64: !Sub |
            #!/bin/bash
            set -e
            # Update system
            yum update -y
            # Install GPU drivers
            yum install -y gcc kernel-devel-$(uname -r)
            # Install NVIDIA drivers and CUDA
            yum install -y nvidia-driver-latest-dkms
            # Install Docker
            amazon-linux-extras install docker -y
            systemctl start docker
            systemctl enable docker
            # Install AWS CLI
            pip3 install awscli --upgrade
            # CloudWatch logs
            yum install -y awslogs
            systemctl start awslogsd
            systemctl enable awslogsd

  # ==================== RDS Database Secret ====================
  DBSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub '${ProjectName}-db-password'
      Description: RDS PostGIS database password
      GenerateSecretString:
        SecretStringTemplate: '{"username": "postgresadmin"}'
        GenerateStringKey: password
        PasswordLength: 32
        ExcludeCharacters: '"@/\'

  # ==================== SageMaker Execution Role ====================
  SageMakerExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-sagemaker-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: sagemaker.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSageMakerFullAccess
      Policies:
        - PolicyName: S3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                  - s3:ListBucket
                Resource:
                  - !GetAtt ArtifactImagesBucket.Arn
                  - !Sub '${ArtifactImagesBucket.Arn}/*'
                  - !GetAtt ResultsBucket.Arn
                  - !Sub '${ResultsBucket.Arn}/*'
        - PolicyName: KMSAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - kms:Decrypt
                  - kms:GenerateDataKey
                Resource: '*'

  # ==================== AWS Batch Setup ====================
  BatchServiceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-batch-service-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: batch.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSBatchServiceRole

  BatchInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref BatchInstanceRole

  BatchInstanceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-batch-instance-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonEC2ContainerServiceforEC2Role
      Policies:
        - PolicyName: S3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:ListBucket
                Resource:
                  - !GetAtt LiDARDataBucket.Arn
                  - !Sub '${LiDARDataBucket.Arn}/*'
                  - !GetAtt ResultsBucket.Arn
                  - !Sub '${ResultsBucket.Arn}/*'

  ComputeEnvironment:
    Type: AWS::Batch::ComputeEnvironment
    Properties:
      ComputeEnvironmentName: !Sub '${ProjectName}-compute-env'
      Type: MANAGED
      ServiceRole: !GetAtt BatchServiceRole.Arn
      ComputeResources:
        Type: EC2
        MinvCpus: 0
        MaxvCpus: 256
        DesiredvCpus: 0
        InstanceTypes:
          - c5.large
          - c5.xlarge
          - c5.2xlarge
          - r5.large
          - r5.xlarge
          - r5.2xlarge
        Subnets:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
        SecurityGroupIds:
          - !Ref BatchSecurityGroup
        InstanceRole: !GetAtt BatchInstanceProfile.Arn

  JobQueue:
    Type: AWS::Batch::JobQueue
    Properties:
      JobQueueName: !Sub '${ProjectName}-job-queue'
      Priority: 1
      ComputeEnvironmentOrder:
        - Order: 1
          ComputeEnvironment: !Ref ComputeEnvironment

  LiDARProcessingJobDefinition:
    Type: AWS::Batch::JobDefinition
    Properties:
      JobDefinitionName: !Sub '${ProjectName}-lidar-processing'
      Type: container
      ContainerProperties:
        Image: !Sub '${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/archaeology-lidar-processor:latest'
        Vcpus: 4
        Memory: 8192
        Environment:
          - Name: RESULTS_BUCKET
            Value: !Ref ResultsBucket
          - Name: LIDAR_BUCKET
            Value: !Ref LiDARDataBucket

  # ==================== Lambda Functions ====================
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-lambda-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
      Policies:
        - PolicyName: S3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                Resource:
                  - !Sub '${ArtifactImagesBucket.Arn}/*'
                  - !Sub '${LiDARDataBucket.Arn}/*'
        - PolicyName: GlueAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - glue:StartJobRun
                  - glue:GetJob
                Resource: '*'

  ImagePreprocessingLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-image-preprocessing'
      Runtime: python3.9
      Role: !GetAtt LambdaExecutionRole.Arn
      Handler: index.handler
      Code:
        ZipFile: |
          import boto3
          import json
          from PIL import Image
          import io

          s3 = boto3.client('s3')

          def handler(event, context):
              """
              Preprocesses artifact images for ML classification.
              Resizes images and normalizes format.
              """
              bucket = event['Records'][0]['s3']['bucket']['name']
              key = event['Records'][0]['s3']['object']['key']

              try:
                  # Download image
                  response = s3.get_object(Bucket=bucket, Key=key)
                  image_data = response['Body'].read()
                  image = Image.open(io.BytesIO(image_data))

                  # Resize to standard dimensions (512x512)
                  image = image.resize((512, 512))

                  # Convert to RGB if necessary
                  if image.mode != 'RGB':
                      image = image.convert('RGB')

                  # Save processed image
                  processed_key = f"processed/{key}"
                  img_byte_arr = io.BytesIO()
                  image.save(img_byte_arr, format='JPEG', quality=90)
                  img_byte_arr.seek(0)

                  s3.put_object(Bucket=bucket, Key=processed_key, Body=img_byte_arr)

                  return {
                      'statusCode': 200,
                      'body': json.dumps('Image preprocessing completed')
                  }
              except Exception as e:
                  print(f"Error: {str(e)}")
                  return {
                      'statusCode': 500,
                      'body': json.dumps(f'Error: {str(e)}')
                  }

  LiDARIngestionLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-lidar-ingestion'
      Runtime: python3.9
      Role: !GetAtt LambdaExecutionRole.Arn
      Handler: index.handler
      Timeout: 60
      Code:
        ZipFile: |
          import boto3
          import json
          import logging

          s3 = boto3.client('s3')
          batch = boto3.client('batch')

          logger = logging.getLogger()
          logger.setLevel(logging.INFO)

          def handler(event, context):
              """
              Triggers batch job for LiDAR data ingestion and processing.
              """
              bucket = event['Records'][0]['s3']['bucket']['name']
              key = event['Records'][0]['s3']['object']['key']

              try:
                  logger.info(f"LiDAR file uploaded: s3://{bucket}/{key}")

                  # Start batch job
                  response = batch.submit_job(
                      jobName=f"lidar-process-{key.replace('/', '-')}",
                      jobQueue='archaeology-site-analysis-job-queue',
                      jobDefinition='archaeology-site-analysis-lidar-processing',
                      containerOverrides={
                          'environment': [
                              {'name': 'INPUT_FILE', 'value': key},
                              {'name': 'BUCKET', 'value': bucket}
                          ]
                      }
                  )

                  return {
                      'statusCode': 202,
                      'body': json.dumps({
                          'message': 'LiDAR processing job submitted',
                          'jobId': response['jobId']
                      })
                  }
              except Exception as e:
                  logger.error(f"Error: {str(e)}")
                  return {
                      'statusCode': 500,
                      'body': json.dumps(f'Error: {str(e)}')
                  }

  # ==================== AWS Glue ====================
  GlueDatabase:
    Type: AWS::Glue::Database
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseInput:
        Name: !Sub '${ProjectName}_catalog'
        Description: Archaeological data catalog and metadata

  GlueCrawler:
    Type: AWS::Glue::Crawler
    Properties:
      Name: !Sub '${ProjectName}-artifact-crawler'
      Role: !GetAtt GlueCrawlerRole.Arn
      DatabaseName: !Ref GlueDatabase
      Targets:
        S3Targets:
          - Path: !Sub 's3://${ArtifactImagesBucket}/processed/'
      SchemaChangePolicy:
        UpdateBehavior: UPDATE_IN_DATABASE
        DeleteBehavior: LOG

  GlueCrawlerRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-glue-crawler-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: glue.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSGlueServiceRole
      Policies:
        - PolicyName: S3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:ListBucket
                Resource:
                  - !GetAtt ArtifactImagesBucket.Arn
                  - !Sub '${ArtifactImagesBucket.Arn}/*'

  # ==================== Athena Workgroup ====================
  AthenaWorkgroup:
    Type: AWS::Athena::WorkGroup
    Properties:
      Name: !Sub '${ProjectName}-workgroup'
      Description: Workgroup for archaeological site metadata queries
      RecursiveDeleteOption: true
      WorkGroupConfiguration:
        ResultConfigurationUpdates:
          OutputLocation: !Sub 's3://${ResultsBucket}/athena-results/'
          EncryptionConfiguration:
            EncryptionOption: SSE_S3
        EnforceWorkGroupConfiguration: true
        PublishCloudWatchMetricsEnabled: true

  AthenaNamedQuery:
    Type: AWS::Athena::NamedQuery
    Properties:
      Name: !Sub '${ProjectName}-site-metadata-query'
      Description: Query for site metadata and artifact inventory
      Database: !Ref GlueDatabase
      WorkGroup: !Ref AthenaWorkgroup
      QueryString: |
        SELECT
          site_id,
          site_name,
          latitude,
          longitude,
          artifact_count,
          collection_date,
          analyst_name
        FROM artifact_metadata
        WHERE collection_date >= date_format(current_date - interval '1' year, '%Y-%m-%d')
        ORDER BY collection_date DESC

Outputs:
  VPCId:
    Description: VPC ID
    Value: !Ref ArchaeologyVPC
    Export:
      Name: !Sub '${ProjectName}-vpc-id'

  LiDARBucketName:
    Description: S3 bucket for LiDAR data
    Value: !Ref LiDARDataBucket
    Export:
      Name: !Sub '${ProjectName}-lidar-bucket'

  ArtifactImagesBucketName:
    Description: S3 bucket for artifact images
    Value: !Ref ArtifactImagesBucket
    Export:
      Name: !Sub '${ProjectName}-artifact-images-bucket'

  GISDataBucketName:
    Description: S3 bucket for GIS data
    Value: !Ref GISDataBucket
    Export:
      Name: !Sub '${ProjectName}-gis-data-bucket'

  ModelsBucketName:
    Description: S3 bucket for 3D models
    Value: !Ref ModelsDataBucket
    Export:
      Name: !Sub '${ProjectName}-3d-models-bucket'

  ResultsBucketName:
    Description: S3 bucket for analysis results
    Value: !Ref ResultsBucket
    Export:
      Name: !Sub '${ProjectName}-results-bucket'

  PostGISDatabaseEndpoint:
    Description: RDS PostGIS database endpoint
    Value: !GetAtt PostGISDatabase.Endpoint.Address
    Export:
      Name: !Sub '${ProjectName}-postgis-endpoint'

  PostGISDatabasePort:
    Description: RDS PostGIS database port
    Value: !GetAtt PostGISDatabase.Endpoint.Port
    Export:
      Name: !Sub '${ProjectName}-postgis-port'

  SageMakerExecutionRoleArn:
    Description: SageMaker execution role ARN
    Value: !GetAtt SageMakerExecutionRole.Arn
    Export:
      Name: !Sub '${ProjectName}-sagemaker-role-arn'

  BatchComputeEnvironmentArn:
    Description: AWS Batch compute environment ARN
    Value: !Ref ComputeEnvironment
    Export:
      Name: !Sub '${ProjectName}-batch-compute-env'

  BatchJobQueueArn:
    Description: AWS Batch job queue ARN
    Value: !Ref JobQueue
    Export:
      Name: !Sub '${ProjectName}-batch-job-queue'

  ImagePreprocessingLambdaArn:
    Description: Image preprocessing Lambda function ARN
    Value: !GetAtt ImagePreprocessingLambda.Arn
    Export:
      Name: !Sub '${ProjectName}-image-lambda-arn'

  LiDARIngestionLambdaArn:
    Description: LiDAR ingestion Lambda function ARN
    Value: !GetAtt LiDARIngestionLambda.Arn
    Export:
      Name: !Sub '${ProjectName}-lidar-lambda-arn'

  GlueDatabaseName:
    Description: Glue database name
    Value: !Ref GlueDatabase
    Export:
      Name: !Sub '${ProjectName}-glue-database'

  AthenaWorkgroupName:
    Description: Athena workgroup name
    Value: !Ref AthenaWorkgroup
    Export:
      Name: !Sub '${ProjectName}-athena-workgroup'

  GPULaunchTemplateId:
    Description: EC2 GPU launch template ID
    Value: !Ref GPULaunchTemplate
    Export:
      Name: !Sub '${ProjectName}-gpu-template-id'
