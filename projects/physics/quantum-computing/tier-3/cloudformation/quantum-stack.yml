AWSTemplateFormatVersion: '2010-09-09'
Description: 'Quantum Computing Infrastructure - AWS Research Jumpstart'

Parameters:
  ProjectName:
    Type: String
    Default: quantum-computing
    Description: Project name for resource naming

  NotebookInstanceType:
    Type: String
    Default: ml.t3.xlarge
    AllowedValues:
      - ml.t3.large
      - ml.t3.xlarge
      - ml.t3.2xlarge
    Description: SageMaker notebook instance type

Resources:
  # S3 Buckets
  QuantumResultsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${ProjectName}-results-${AWS::AccountId}'
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  CircuitLibraryBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${ProjectName}-circuits-${AWS::AccountId}'
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  # IAM Role for Braket
  BraketExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-braket-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - braket.amazonaws.com
                - sagemaker.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonBraketFullAccess
        - arn:aws:iam::aws:policy/AmazonSageMakerFullAccess
        - arn:aws:iam::aws:policy/AmazonBedrockFullAccess
      Policies:
        - PolicyName: S3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:ListBucket
                Resource:
                  - !Sub '${QuantumResultsBucket.Arn}/*'
                  - !GetAtt QuantumResultsBucket.Arn
                  - !Sub '${CircuitLibraryBucket.Arn}/*'
                  - !GetAtt CircuitLibraryBucket.Arn

  # SageMaker Notebook
  NotebookInstance:
    Type: AWS::SageMaker::NotebookInstance
    Properties:
      NotebookInstanceName: !Sub '${ProjectName}-notebook'
      InstanceType: !Ref NotebookInstanceType
      RoleArn: !GetAtt BraketExecutionRole.Arn
      VolumeSizeInGB: 50
      DefaultCodeRepository: https://github.com/aws/research-jumpstart.git

Outputs:
  QuantumResultsBucketName:
    Description: S3 bucket for quantum experiment results
    Value: !Ref QuantumResultsBucket
    Export:
      Name: !Sub '${AWS::StackName}-ResultsBucket'

  CircuitLibraryBucketName:
    Description: S3 bucket for circuit library
    Value: !Ref CircuitLibraryBucket
    Export:
      Name: !Sub '${AWS::StackName}-CircuitBucket'

  BraketExecutionRoleArn:
    Description: IAM role for Braket execution
    Value: !GetAtt BraketExecutionRole.Arn
    Export:
      Name: !Sub '${AWS::StackName}-BraketRole'

  NotebookInstanceName:
    Description: SageMaker notebook instance
    Value: !GetAtt NotebookInstance.NotebookInstanceName

  NotebookURL:
    Description: URL to access the notebook
    Value: !Sub 'https://${NotebookInstance.NotebookInstanceName}.notebook.${AWS::Region}.sagemaker.aws/lab'
