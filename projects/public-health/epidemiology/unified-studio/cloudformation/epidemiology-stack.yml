AWSTemplateFormatVersion: '2010-09-09'
Description: 'CloudFormation template for epidemiology surveillance system with real-time data processing and ML capabilities'

Parameters:
  ProjectName:
    Type: String
    Default: epidemiology-surveillance
    Description: Project name for resource naming
    MaxLength: 32
    MinLength: 1
    AllowedPattern: '^[a-z0-9-]*$'

  NeptuneDBInstanceClass:
    Type: String
    Default: db.r5.large
    Description: Neptune database instance class
    AllowedValues:
      - db.r5.large
      - db.r5.xlarge
      - db.r5.2xlarge
      - db.r6i.xlarge
      - db.r6i.2xlarge

  Environment:
    Type: String
    Default: dev
    Description: Environment name
    AllowedValues:
      - dev
      - staging
      - prod

Mappings:
  SubnetConfig:
    VPC:
      CIDR: '10.0.0.0/16'
    PublicSubnet1:
      CIDR: '10.0.1.0/24'
    PublicSubnet2:
      CIDR: '10.0.2.0/24'
    PrivateSubnet1:
      CIDR: '10.0.10.0/24'
    PrivateSubnet2:
      CIDR: '10.0.11.0/24'

Resources:
  # ==================== VPC Infrastructure ====================
  EpidemiologyVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !FindInMap [SubnetConfig, VPC, CIDR]
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-vpc'

  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref EpidemiologyVPC
      CidrBlock: !FindInMap [SubnetConfig, PublicSubnet1, CIDR]
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-public-subnet-1'

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref EpidemiologyVPC
      CidrBlock: !FindInMap [SubnetConfig, PublicSubnet2, CIDR]
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-public-subnet-2'

  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref EpidemiologyVPC
      CidrBlock: !FindInMap [SubnetConfig, PrivateSubnet1, CIDR]
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-private-subnet-1'

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref EpidemiologyVPC
      CidrBlock: !FindInMap [SubnetConfig, PrivateSubnet2, CIDR]
      AvailabilityZone: !Select [1, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-private-subnet-2'

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-igw'

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref EpidemiologyVPC
      InternetGatewayId: !Ref InternetGateway

  NATGatewayEIP:
    Type: AWS::EC2::EIP
    DependsOn: AttachGateway
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-nat-eip'

  NATGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NATGatewayEIP.AllocationId
      SubnetId: !Ref PublicSubnet1
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-nat-gateway'

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref EpidemiologyVPC
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-public-rt'

  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet1
      RouteTableId: !Ref PublicRouteTable

  PublicSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet2
      RouteTableId: !Ref PublicRouteTable

  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref EpidemiologyVPC
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-private-rt'

  PrivateRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NATGateway

  PrivateSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet1
      RouteTableId: !Ref PrivateRouteTable

  PrivateSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet2
      RouteTableId: !Ref PrivateRouteTable

  S3Endpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref EpidemiologyVPC
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.s3'
      RouteTableIds:
        - !Ref PrivateRouteTable
        - !Ref PublicRouteTable

  # ==================== Security Groups ====================
  NeptuneSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Neptune database
      VpcId: !Ref EpidemiologyVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 8182
          ToPort: 8182
          SourceSecurityGroupId: !Ref BatchSecurityGroup
        - IpProtocol: tcp
          FromPort: 8182
          ToPort: 8182
          SourceSecurityGroupId: !Ref LambdaSecurityGroup
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-neptune-sg'

  BatchSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for AWS Batch compute environment
      VpcId: !Ref EpidemiologyVPC
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-batch-sg'

  LambdaSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Lambda functions
      VpcId: !Ref EpidemiologyVPC
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-lambda-sg'

  # ==================== S3 Buckets ====================
  RawDataBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${ProjectName}-raw-data-${AWS::AccountId}'
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldVersions
            NoncurrentVersionExpirationInDays: 90
            Status: Enabled
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-raw-data'

  ProcessedDataBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${ProjectName}-processed-data-${AWS::AccountId}'
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-processed-data'

  ModelsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${ProjectName}-models-${AWS::AccountId}'
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-models'

  ResultsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${ProjectName}-results-${AWS::AccountId}'
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-results'

  # ==================== Kinesis Streams ====================
  SyndromicSurveillanceStream:
    Type: AWS::Kinesis::Stream
    Properties:
      Name: !Sub '${ProjectName}-syndromic-surveillance'
      StreamModeDetails:
        StreamMode: ON_DEMAND
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-syndromic-stream'

  SocialMediaStream:
    Type: AWS::Kinesis::Stream
    Properties:
      Name: !Sub '${ProjectName}-social-media-trends'
      StreamModeDetails:
        StreamMode: ON_DEMAND
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-social-media-stream'

  # ==================== Amazon Timestream ====================
  TimestreamDatabase:
    Type: AWS::Timestream::Database
    Properties:
      DatabaseName: !Sub '${ProjectName}-db'
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-timestream-db'

  DiseaseCasesTable:
    Type: AWS::Timestream::Table
    Properties:
      DatabaseName: !Ref TimestreamDatabase
      TableName: disease_cases
      RetentionProperties:
        MemoryStoreRetentionPeriodInHours: 168
        MagneticStoreRetentionPeriodInDays: 1095
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-disease-cases-table'

  SyndromicSurveillanceTable:
    Type: AWS::Timestream::Table
    Properties:
      DatabaseName: !Ref TimestreamDatabase
      TableName: syndromic_surveillance
      RetentionProperties:
        MemoryStoreRetentionPeriodInHours: 336
        MagneticStoreRetentionPeriodInDays: 730
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-syndromic-table'

  # ==================== Neptune Graph Database ====================
  NeptuneSubnetGroup:
    Type: AWS::Neptune::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Subnet group for Neptune database
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-neptune-subnet-group'

  NeptuneClusterParameterGroup:
    Type: AWS::Neptune::DBClusterParameterGroup
    Properties:
      Description: Cluster parameter group for Neptune
      Family: neptune1.2
      Parameters:
        neptune_lab_mode: 'true'
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-neptune-cluster-params'

  NeptuneDBParameterGroup:
    Type: AWS::Neptune::DBParameterGroup
    Properties:
      Description: DB parameter group for Neptune
      Family: neptune1.2
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-neptune-db-params'

  NeptuneCluster:
    Type: AWS::Neptune::DBCluster
    DeletionPolicy: Snapshot
    Properties:
      DBClusterIdentifier: !Sub '${ProjectName}-contact-tracing'
      IamAuthEnabled: true
      DBClusterParameterGroupName: !Ref NeptuneClusterParameterGroup
      DBSubnetGroupName: !Ref NeptuneSubnetGroup
      VpcSecurityGroupIds:
        - !Ref NeptuneSecurityGroup
      StorageEncrypted: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-neptune-cluster'

  NeptuneInstance:
    Type: AWS::Neptune::DBInstance
    Properties:
      DBInstanceIdentifier: !Sub '${ProjectName}-neptune-instance'
      DBInstanceClass: !Ref NeptuneDBInstanceClass
      DBClusterIdentifier: !Ref NeptuneCluster
      DBParameterGroupName: !Ref NeptuneDBParameterGroup
      AutoMinorVersionUpgrade: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-neptune-instance'

  # ==================== IAM Roles ====================
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-lambda-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
      Policies:
        - PolicyName: S3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:ListBucket
                Resource:
                  - !GetAtt RawDataBucket.Arn
                  - !Sub '${RawDataBucket.Arn}/*'
                  - !GetAtt ProcessedDataBucket.Arn
                  - !Sub '${ProcessedDataBucket.Arn}/*'
        - PolicyName: KinesisAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - kinesis:GetRecords
                  - kinesis:GetShardIterator
                  - kinesis:DescribeStream
                  - kinesis:ListStreams
                  - kinesis:ListShards
                  - kinesis:PutRecord
                  - kinesis:PutRecords
                Resource:
                  - !GetAtt SyndromicSurveillanceStream.Arn
                  - !GetAtt SocialMediaStream.Arn
        - PolicyName: TimestreamAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - timestream:WriteRecords
                  - timestream:DescribeTable
                  - timestream:DescribeDatabase
                Resource:
                  - !Sub 'arn:aws:timestream:${AWS::Region}:${AWS::AccountId}:database/${TimestreamDatabase}'
                  - !Sub 'arn:aws:timestream:${AWS::Region}:${AWS::AccountId}:database/${TimestreamDatabase}/*'
        - PolicyName: CloudWatchLogs
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: arn:aws:logs:*:*:*

  SageMakerExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-sagemaker-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: sagemaker.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: S3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                  - s3:ListBucket
                Resource:
                  - !GetAtt ProcessedDataBucket.Arn
                  - !Sub '${ProcessedDataBucket.Arn}/*'
                  - !GetAtt ModelsBucket.Arn
                  - !Sub '${ModelsBucket.Arn}/*'
        - PolicyName: TimestreamAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - timestream:Select
                  - timestream:DescribeTable
                  - timestream:DescribeDatabase
                Resource:
                  - !Sub 'arn:aws:timestream:${AWS::Region}:${AWS::AccountId}:database/${TimestreamDatabase}'
                  - !Sub 'arn:aws:timestream:${AWS::Region}:${AWS::AccountId}:database/${TimestreamDatabase}/*'

  BatchExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-batch-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: batch.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSBatchServiceRole

  BatchJobRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-batch-job-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: S3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:ListBucket
                Resource:
                  - !GetAtt ProcessedDataBucket.Arn
                  - !Sub '${ProcessedDataBucket.Arn}/*'
                  - !GetAtt ResultsBucket.Arn
                  - !Sub '${ResultsBucket.Arn}/*'

  BatchJobInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref BatchJobRole

  QuickSightServiceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-quicksight-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: quicksight.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: S3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:ListBucket
                Resource:
                  - !GetAtt ResultsBucket.Arn
                  - !Sub '${ResultsBucket.Arn}/*'
        - PolicyName: TimestreamAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - timestream:Select
                  - timestream:DescribeTable
                  - timestream:DescribeDatabase
                Resource:
                  - !Sub 'arn:aws:timestream:${AWS::Region}:${AWS::AccountId}:database/${TimestreamDatabase}'
                  - !Sub 'arn:aws:timestream:${AWS::Region}:${AWS::AccountId}:database/${TimestreamDatabase}/*'

  # ==================== Lambda Functions ====================
  CDCDataIngestionFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-cdc-ingestion'
      Runtime: python3.11
      Handler: index.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
      Environment:
        Variables:
          RAW_DATA_BUCKET: !Ref RawDataBucket
          TIMESTREAM_DATABASE: !Ref TimestreamDatabase
          TIMESTREAM_TABLE: !Ref DiseaseCasesTable
      Code:
        ZipFile: |
          import json
          import boto3
          import os
          from datetime import datetime

          s3_client = boto3.client('s3')
          timestream_client = boto3.client('timestream-write')

          def lambda_handler(event, context):
              raw_bucket = os.environ['RAW_DATA_BUCKET']
              database = os.environ['TIMESTREAM_DATABASE']
              table = os.environ['TIMESTREAM_TABLE']

              try:
                  timestamp = int(datetime.now().timestamp() * 1000)

                  records = [{
                      'Time': str(timestamp),
                      'TimeUnit': 'MILLISECONDS',
                      'Dimensions': [
                          {'Name': 'source', 'Value': 'CDC'},
                          {'Name': 'disease', 'Value': 'surveillance'}
                      ],
                      'MeasureName': 'cases_reported',
                      'MeasureValue': '0',
                      'MeasureValueType': 'BIGINT'
                  }]

                  response = timestream_client.write_records(
                      DatabaseName=database,
                      TableName=table,
                      Records=records,
                      CommonAttributes={
                          'Dimensions': [{'Name': 'source', 'Value': 'CDC'}]
                      }
                  )

                  return {
                      'statusCode': 200,
                      'body': json.dumps('CDC data ingestion successful')
                  }
              except Exception as e:
                  print(f'Error: {str(e)}')
                  return {
                      'statusCode': 500,
                      'body': json.dumps(f'Error: {str(e)}')
                  }
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-cdc-ingestion'

  EARSAberrationDetectionFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-ears-detection'
      Runtime: python3.11
      Handler: index.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
      Environment:
        Variables:
          PROCESSED_BUCKET: !Ref ProcessedDataBucket
      Code:
        ZipFile: |
          import json
          import base64

          def lambda_handler(event, context):
              try:
                  for record in event['Records']:
                      payload = base64.b64decode(record['kinesis']['data'])
                      data = json.loads(payload)

                      anomaly_score = calculate_anomaly(data)

                      if anomaly_score > 0.8:
                          print(f'Anomaly detected: {anomaly_score}')

                  return {
                      'statusCode': 200,
                      'body': json.dumps('Aberration detection complete')
                  }
              except Exception as e:
                  print(f'Error: {str(e)}')
                  return {
                      'statusCode': 500,
                      'body': json.dumps(f'Error: {str(e)}')
                  }

          def calculate_anomaly(data):
              return 0.5

  CDCIngestionEventRule:
    Type: AWS::Events::Rule
    Properties:
      Name: !Sub '${ProjectName}-cdc-daily-trigger'
      Description: Triggers CDC data ingestion daily
      ScheduleExpression: 'cron(0 2 * * ? *)'
      State: ENABLED
      Targets:
        - Arn: !GetAtt CDCDataIngestionFunction.Arn
          Id: CDCIngestionTarget

  CDCIngestionEventPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref CDCDataIngestionFunction
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt CDCIngestionEventRule.Arn

  EARSEventSourceMapping:
    Type: AWS::Lambda::EventSourceMapping
    Properties:
      EventSourceArn: !GetAtt SyndromicSurveillanceStream.Arn
      FunctionName: !Ref EARSAberrationDetectionFunction
      Enabled: true
      BatchSize: 100
      StartingPosition: LATEST

  # ==================== AWS Glue ====================
  GlueDatabase:
    Type: AWS::Glue::Database
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseInput:
        Name: !Sub '${ProjectName}_surveillance_db'
        Description: Glue database for disease surveillance data

  CasesTable:
    Type: AWS::Glue::Table
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseName: !Ref GlueDatabase
      TableInput:
        Name: cases
        TableType: EXTERNAL_TABLE
        StorageDescriptor:
          Columns:
            - Name: case_id
              Type: string
            - Name: disease
              Type: string
            - Name: date_reported
              Type: string
            - Name: location
              Type: string
            - Name: severity
              Type: string
          Location: !Sub 's3://${ProcessedDataBucket}/cases/'
          InputFormat: org.apache.hadoop.mapred.TextInputFormat
          OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
          SerdeInfo:
            SerializationLibrary: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe
            Parameters:
              field.delim: ','

  DemographicsTable:
    Type: AWS::Glue::Table
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseName: !Ref GlueDatabase
      TableInput:
        Name: demographics
        TableType: EXTERNAL_TABLE
        StorageDescriptor:
          Columns:
            - Name: patient_id
              Type: string
            - Name: age
              Type: int
            - Name: gender
              Type: string
            - Name: location
              Type: string
          Location: !Sub 's3://${ProcessedDataBucket}/demographics/'
          InputFormat: org.apache.hadoop.mapred.TextInputFormat
          OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
          SerdeInfo:
            SerializationLibrary: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe
            Parameters:
              field.delim: ','

  # ==================== Amazon Athena ====================
  AthenaWorkgroup:
    Type: AWS::Athena::WorkGroup
    Properties:
      Name: !Sub '${ProjectName}-surveillance-workgroup'
      Description: Workgroup for epidemiology surveillance queries
      RecursiveDeleteOption: true
      WorkGroupConfiguration:
        ResultConfigurationUpdates:
          OutputLocation: !Sub 's3://${ResultsBucket}/athena-results/'
        EnforceWorkGroupConfiguration: true
        PublishCloudWatchMetricsEnabled: true

  # ==================== AWS Batch ====================
  BatchComputeEnvironment:
    Type: AWS::Batch::ComputeEnvironment
    Properties:
      ComputeEnvironmentName: !Sub '${ProjectName}-compute-env'
      Type: MANAGED
      State: ENABLED
      ComputeResources:
        Type: EC2
        MinvCpus: 0
        MaxvCpus: 256
        DesiredvCpus: 0
        InstanceTypes:
          - optimal
        Subnets:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
        SecurityGroupIds:
          - !Ref BatchSecurityGroup
        InstanceRole: !GetAtt BatchJobInstanceProfile.Arn
      ServiceRole: !GetAtt BatchExecutionRole.Arn

  BatchJobQueue:
    Type: AWS::Batch::JobQueue
    Properties:
      JobQueueName: !Sub '${ProjectName}-job-queue'
      State: ENABLED
      Priority: 1
      ComputeEnvironmentOrder:
        - Order: 1
          ComputeEnvironment: !Ref BatchComputeEnvironment

  BatchJobDefinition:
    Type: AWS::Batch::JobDefinition
    Properties:
      JobDefinitionName: !Sub '${ProjectName}-epidemic-simulation'
      Type: container
      ContainerProperties:
        Image: !Sub '${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/epidemic-model:latest'
        Vcpus: 2
        Memory: 2048
        Environment:
          - Name: RESULTS_BUCKET
            Value: !Ref ResultsBucket
          - Name: MODEL_TYPE
            Value: agent-based
        MountPoints: []
        Volumes: []

Outputs:
  RawDataBucketName:
    Description: Name of the raw data S3 bucket
    Value: !Ref RawDataBucket
    Export:
      Name: !Sub '${ProjectName}-raw-data-bucket'

  ProcessedDataBucketName:
    Description: Name of the processed data S3 bucket
    Value: !Ref ProcessedDataBucket
    Export:
      Name: !Sub '${ProjectName}-processed-data-bucket'

  ModelsBucketName:
    Description: Name of the models S3 bucket
    Value: !Ref ModelsBucket
    Export:
      Name: !Sub '${ProjectName}-models-bucket'

  ResultsBucketName:
    Description: Name of the results S3 bucket
    Value: !Ref ResultsBucket
    Export:
      Name: !Sub '${ProjectName}-results-bucket'

  SyndromicStreamArn:
    Description: ARN of the syndromic surveillance stream
    Value: !GetAtt SyndromicSurveillanceStream.Arn
    Export:
      Name: !Sub '${ProjectName}-syndromic-stream-arn'

  SocialMediaStreamArn:
    Description: ARN of the social media trends stream
    Value: !GetAtt SocialMediaStream.Arn
    Export:
      Name: !Sub '${ProjectName}-social-media-stream-arn'

  TimestreamDatabaseName:
    Description: Name of the Timestream database
    Value: !Ref TimestreamDatabase
    Export:
      Name: !Sub '${ProjectName}-timestream-db'

  NeptuneEndpoint:
    Description: Neptune cluster endpoint
    Value: !GetAtt NeptuneCluster.Endpoint
    Export:
      Name: !Sub '${ProjectName}-neptune-endpoint'

  NeptunePort:
    Description: Neptune cluster port
    Value: !GetAtt NeptuneCluster.Port
    Export:
      Name: !Sub '${ProjectName}-neptune-port'

  CDCIngestionFunctionArn:
    Description: ARN of CDC data ingestion Lambda function
    Value: !GetAtt CDCDataIngestionFunction.Arn
    Export:
      Name: !Sub '${ProjectName}-cdc-ingestion-arn'

  EARSDetectionFunctionArn:
    Description: ARN of EARS aberration detection Lambda function
    Value: !GetAtt EARSAberrationDetectionFunction.Arn
    Export:
      Name: !Sub '${ProjectName}-ears-detection-arn'

  GlueDatabaseName:
    Description: Name of the Glue database
    Value: !Ref GlueDatabase
    Export:
      Name: !Sub '${ProjectName}-glue-db'

  AthenaWorkgroupName:
    Description: Name of the Athena workgroup
    Value: !Ref AthenaWorkgroup
    Export:
      Name: !Sub '${ProjectName}-athena-workgroup'

  BatchJobQueueArn:
    Description: ARN of the Batch job queue
    Value: !GetAtt BatchJobQueue.JobQueueArn
    Export:
      Name: !Sub '${ProjectName}-batch-job-queue-arn'

  VPCId:
    Description: VPC ID
    Value: !Ref EpidemiologyVPC
    Export:
      Name: !Sub '${ProjectName}-vpc-id'
