AWSTemplateFormatVersion: '2010-09-09'
Description: 'CloudFormation template for marine science analysis infrastructure with satellite data processing, species distribution modeling, and coral monitoring'

Parameters:
  ProjectName:
    Type: String
    Default: ocean-marine-analysis
    Description: Project name for resource naming
    MinLength: 3
    MaxLength: 32

  TimestreamRetentionDays:
    Type: Number
    Default: 365
    Description: Retention period in days for Timestream data
    MinValue: 1
    MaxValue: 36500

  Environment:
    Type: String
    Default: dev
    AllowedValues:
      - dev
      - staging
      - prod
    Description: Environment name

  LatestAmiId:
    Type: AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>
    Default: /aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "Project Configuration"
        Parameters:
          - ProjectName
          - Environment
          - TimestreamRetentionDays

Resources:
  # ==================== VPC Infrastructure ====================
  MarineVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-vpc'

  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref MarineVPC
      CidrBlock: 10.0.1.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-public-subnet-1'

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref MarineVPC
      CidrBlock: 10.0.2.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-public-subnet-2'

  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref MarineVPC
      CidrBlock: 10.0.10.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-private-subnet-1'

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref MarineVPC
      CidrBlock: 10.0.11.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-private-subnet-2'

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-igw'

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref MarineVPC
      InternetGatewayId: !Ref InternetGateway

  NATGatewayEIP:
    Type: AWS::EC2::EIP
    DependsOn: AttachGateway
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-nat-eip'

  NATGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NATGatewayEIP.AllocationId
      SubnetId: !Ref PublicSubnet1
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-nat'

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref MarineVPC
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-public-rt'

  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet1
      RouteTableId: !Ref PublicRouteTable

  PublicSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet2
      RouteTableId: !Ref PublicRouteTable

  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref MarineVPC
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-private-rt'

  PrivateRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NATGateway

  PrivateSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet1
      RouteTableId: !Ref PrivateRouteTable

  PrivateSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet2
      RouteTableId: !Ref PrivateRouteTable

  # S3 VPC Endpoint
  S3VPCEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref MarineVPC
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.s3'
      RouteTableIds:
        - !Ref PrivateRouteTable
        - !Ref PublicRouteTable

  # ==================== Security Groups ====================
  LambdaSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Lambda functions
      VpcId: !Ref MarineVPC
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-lambda-sg'

  BatchComputeSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for AWS Batch compute instances
      VpcId: !Ref MarineVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          SourceSecurityGroupId: !Ref BatchComputeSecurityGroup
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-batch-sg'

  # ==================== S3 Buckets ====================
  OceanSatelliteDataBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${ProjectName}-satellite-data-${AWS::AccountId}'
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-satellite-data'
        - Key: DataType
          Value: 'MODIS, VIIRS, Sentinel-3'

  ArgoFloatDataBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${ProjectName}-argo-float-${AWS::AccountId}'
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-argo-float'
        - Key: DataType
          Value: 'Temperature, Salinity Profiles'

  SpeciesOccurrenceBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${ProjectName}-species-occurrence-${AWS::AccountId}'
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-species-occurrence'
        - Key: DataType
          Value: 'OBIS, GBIF data'

  CoralImageryBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${ProjectName}-coral-imagery-${AWS::AccountId}'
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-coral-imagery'
        - Key: DataType
          Value: 'Landsat, Sentinel-2'

  AnalysisResultsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${ProjectName}-analysis-results-${AWS::AccountId}'
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-analysis-results'
        - Key: Purpose
          Value: 'Analysis outputs'

  # ==================== AWS Timestream ====================
  TimestreamDatabase:
    Type: AWS::Timestream::Database
    Properties:
      DatabaseName: !Sub '${ProjectName}-buoy-database'
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-timestream-db'

  SensorMeasurementsTable:
    Type: AWS::Timestream::Table
    Properties:
      DatabaseName: !Ref TimestreamDatabase
      TableName: sensor-measurements
      RetentionProperties:
        MemoryStoreRetentionPeriodInHours: 12
        MagneticStoreRetentionPeriodInDays: !Ref TimestreamRetentionDays
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-sensor-measurements'
        - Key: Measurements
          Value: 'Temperature, Salinity, Wind, Waves'

  # ==================== AWS Glue ====================
  GlueDatabase:
    Type: AWS::Glue::Database
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseInput:
        Name: !Sub '${ProjectName}-marine-data-catalog'
        Description: Marine data catalog for species occurrence and satellite data

  SpeciesOccurrenceCrawler:
    Type: AWS::Glue::Crawler
    Properties:
      Name: !Sub '${ProjectName}-species-crawler'
      Role: !GetAtt GlueCrawlerRole.Arn
      DatabaseName: !Ref GlueDatabase
      S3Targets:
        - Path: !Sub 's3://${SpeciesOccurrenceBucket}/data/'
      SchemaChangePolicy:
        UpdateBehavior: UPDATE_IN_DATABASE
        DeleteBehavior: LOG
      Description: Crawler for OBIS and GBIF species occurrence data

  GlueCrawlerRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: glue.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSGlueServiceRole
      Policies:
        - PolicyName: GlueS3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:ListBucket
                Resource:
                  - !GetAtt SpeciesOccurrenceBucket.Arn
                  - !Sub '${SpeciesOccurrenceBucket.Arn}/*'

  # ==================== AWS Athena ====================
  AthenaWorkgroup:
    Type: AWS::Athena::WorkGroup
    Properties:
      Name: !Sub '${ProjectName}-species-queries'
      WorkGroupConfiguration:
        ResultConfigurationUpdates:
          OutputLocation: !Sub 's3://${AnalysisResultsBucket}/athena-results/'
        EnforceWorkGroupConfiguration: true
        PublishCloudWatchMetricsEnabled: true
      Description: Workgroup for SQL queries on species occurrence data
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-athena-workgroup'

  # ==================== IAM Roles ====================
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
      Policies:
        - PolicyName: LambdaS3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:ListBucket
                Resource:
                  - !GetAtt OceanSatelliteDataBucket.Arn
                  - !Sub '${OceanSatelliteDataBucket.Arn}/*'
                  - !GetAtt ArgoFloatDataBucket.Arn
                  - !Sub '${ArgoFloatDataBucket.Arn}/*'
                  - !GetAtt AnalysisResultsBucket.Arn
                  - !Sub '${AnalysisResultsBucket.Arn}/*'
        - PolicyName: LambdaTimestreamAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - timestream:WriteRecords
                  - timestream:DescribeTable
                  - timestream:DescribeDatabase
                Resource: '*'
        - PolicyName: LambdaLogsAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:*'

  SageMakerExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: sagemaker.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSageMakerFullAccess
      Policies:
        - PolicyName: SageMakerS3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:ListBucket
                Resource:
                  - !GetAtt OceanSatelliteDataBucket.Arn
                  - !Sub '${OceanSatelliteDataBucket.Arn}/*'
                  - !GetAtt SpeciesOccurrenceBucket.Arn
                  - !Sub '${SpeciesOccurrenceBucket.Arn}/*'
                  - !GetAtt CoralImageryBucket.Arn
                  - !Sub '${CoralImageryBucket.Arn}/*'
                  - !GetAtt AnalysisResultsBucket.Arn
                  - !Sub '${AnalysisResultsBucket.Arn}/*'

  BatchServiceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: batch.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSBatchServiceRole

  BatchInstanceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonEC2ContainerServiceforEC2Role
      Policies:
        - PolicyName: BatchS3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:ListBucket
                Resource:
                  - !GetAtt OceanSatelliteDataBucket.Arn
                  - !Sub '${OceanSatelliteDataBucket.Arn}/*'
                  - !GetAtt AnalysisResultsBucket.Arn
                  - !Sub '${AnalysisResultsBucket.Arn}/*'
        - PolicyName: ECRAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - ecr:GetAuthorizationToken
                  - ecr:BatchGetImage
                  - ecr:GetDownloadUrlForLayer
                  - ecr:BatchCheckLayerAvailability
                Resource: '*'

  BatchInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref BatchInstanceRole

  # ==================== AWS Lambda ====================
  ERDDAPDataIngestionLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-erddap-ingestion'
      Runtime: python3.11
      Handler: index.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 300
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
      Environment:
        Variables:
          SATELLITE_BUCKET: !Ref OceanSatelliteDataBucket
          ARGO_BUCKET: !Ref ArgoFloatDataBucket
          TIMESTREAM_DB: !Ref TimestreamDatabase
          TIMESTREAM_TABLE: !Ref SensorMeasurementsTable
      Code:
        ZipFile: |
          import json
          import boto3
          import os
          from datetime import datetime

          s3 = boto3.client('s3')
          timestream = boto3.client('timestream-write')

          def lambda_handler(event, context):
              """Ingest ERDDAP buoy data into Timestream"""
              satellite_bucket = os.environ['SATELLITE_BUCKET']
              argo_bucket = os.environ['ARGO_BUCKET']

              try:
                  # Placeholder for ERDDAP data retrieval and ingestion logic
                  print(f"Ingesting data to {satellite_bucket} and {argo_bucket}")
                  return {
                      'statusCode': 200,
                      'body': json.dumps('Data ingestion initiated')
                  }
              except Exception as e:
                  print(f"Error: {str(e)}")
                  return {
                      'statusCode': 500,
                      'body': json.dumps(f'Error: {str(e)}')
                  }
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-erddap-ingestion'

  NetCDFPreprocessingLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-netcdf-preprocessing'
      Runtime: python3.11
      Handler: index.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 300
      MemorySize: 1024
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
      Environment:
        Variables:
          SATELLITE_BUCKET: !Ref OceanSatelliteDataBucket
          RESULTS_BUCKET: !Ref AnalysisResultsBucket
      Code:
        ZipFile: |
          import json
          import boto3
          import os

          s3 = boto3.client('s3')

          def lambda_handler(event, context):
              """Preprocess netCDF files from satellite data"""
              satellite_bucket = os.environ['SATELLITE_BUCKET']
              results_bucket = os.environ['RESULTS_BUCKET']

              try:
                  # Placeholder for netCDF preprocessing logic
                  print(f"Processing netCDF files from {satellite_bucket}")
                  return {
                      'statusCode': 200,
                      'body': json.dumps('NetCDF preprocessing initiated')
                  }
              except Exception as e:
                  print(f"Error: {str(e)}")
                  return {
                      'statusCode': 500,
                      'body': json.dumps(f'Error: {str(e)}')
                  }
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-netcdf-preprocessing'

  CoralBleachingAlertLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-coral-bleaching-alert'
      Runtime: python3.11
      Handler: index.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 300
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
      Environment:
        Variables:
          CORAL_BUCKET: !Ref CoralImageryBucket
          TIMESTREAM_DB: !Ref TimestreamDatabase
          RESULTS_BUCKET: !Ref AnalysisResultsBucket
      Code:
        ZipFile: |
          import json
          import boto3
          import os

          s3 = boto3.client('s3')
          timestream = boto3.client('timestream-query')

          def lambda_handler(event, context):
              """Generate coral bleaching alerts based on temperature anomalies"""
              coral_bucket = os.environ['CORAL_BUCKET']

              try:
                  # Placeholder for coral bleaching alert generation logic
                  print(f"Analyzing coral imagery from {coral_bucket}")
                  return {
                      'statusCode': 200,
                      'body': json.dumps('Coral bleaching analysis completed')
                  }
              except Exception as e:
                  print(f"Error: {str(e)}")
                  return {
                      'statusCode': 500,
                      'body': json.dumps(f'Error: {str(e)}')
                  }
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-coral-bleaching-alert'

  # ==================== EventBridge Rules ====================
  DailyERDDAPIngestionRule:
    Type: AWS::Events::Rule
    Properties:
      Name: !Sub '${ProjectName}-daily-erddap'
      ScheduleExpression: 'cron(0 0 * * ? *)'
      State: ENABLED
      Targets:
        - Arn: !GetAtt ERDDAPDataIngestionLambda.Arn
          Id: ERDDAPIngestionTarget

  ERDDAPLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref ERDDAPDataIngestionLambda
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt DailyERDDAPIngestionRule.Arn

  DailyCoralAlertRule:
    Type: AWS::Events::Rule
    Properties:
      Name: !Sub '${ProjectName}-daily-coral-alert'
      ScheduleExpression: 'cron(0 6 * * ? *)'
      State: ENABLED
      Targets:
        - Arn: !GetAtt CoralBleachingAlertLambda.Arn
          Id: CoralAlertTarget

  CoralAlertLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref CoralBleachingAlertLambda
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt DailyCoralAlertRule.Arn

  # ==================== AWS Batch ====================
  BatchComputeEnvironment:
    Type: AWS::Batch::ComputeEnvironment
    Properties:
      ComputeEnvironmentName: !Sub '${ProjectName}-netcdf-compute'
      Type: MANAGED
      State: ENABLED
      ServiceRole: !GetAtt BatchServiceRole.Arn
      ComputeResources:
        Type: EC2
        AllocationStrategy: SPOT_CAPACITY_OPTIMIZED
        MinvCpus: 0
        MaxvCpus: 256
        DesiredvCpus: 0
        InstanceTypes:
          - r5.2xlarge
          - r5.4xlarge
          - r5a.2xlarge
          - r5a.4xlarge
        Subnets:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
        SecurityGroupIds:
          - !Ref BatchComputeSecurityGroup
        InstanceRole: !GetAtt BatchInstanceProfile.Arn
        Tags:
          Name: !Sub '${ProjectName}-batch-instance'

  BatchJobQueue:
    Type: AWS::Batch::JobQueue
    Properties:
      JobQueueName: !Sub '${ProjectName}-netcdf-queue'
      State: ENABLED
      Priority: 1
      ComputeEnvironmentOrder:
        - Order: 1
          ComputeEnvironment: !Ref BatchComputeEnvironment

  NetCDFProcessingJobDefinition:
    Type: AWS::Batch::JobDefinition
    Properties:
      JobDefinitionName: !Sub '${ProjectName}-netcdf-processing'
      Type: container
      ContainerProperties:
        Image: !Sub '${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/marine-science:latest'
        Vcpus: 4
        Memory: 16000
        Environment:
          - Name: SATELLITE_BUCKET
            Value: !Ref OceanSatelliteDataBucket
          - Name: RESULTS_BUCKET
            Value: !Ref AnalysisResultsBucket
        MountPoints: []
        Volumes: []
      Tags:
        Name: !Sub '${ProjectName}-netcdf-job-def'

Outputs:
  SatelliteDataBucket:
    Description: S3 bucket for ocean satellite data
    Value: !Ref OceanSatelliteDataBucket
    Export:
      Name: !Sub '${ProjectName}-satellite-bucket'

  ArgoFloatBucket:
    Description: S3 bucket for Argo float data
    Value: !Ref ArgoFloatDataBucket
    Export:
      Name: !Sub '${ProjectName}-argo-bucket'

  SpeciesOccurrenceBucketName:
    Description: S3 bucket for species occurrence data
    Value: !Ref SpeciesOccurrenceBucket
    Export:
      Name: !Sub '${ProjectName}-species-bucket'

  CoralImageryBucketName:
    Description: S3 bucket for coral imagery
    Value: !Ref CoralImageryBucket
    Export:
      Name: !Sub '${ProjectName}-coral-bucket'

  AnalysisResultsBucketName:
    Description: S3 bucket for analysis results
    Value: !Ref AnalysisResultsBucket
    Export:
      Name: !Sub '${ProjectName}-results-bucket'

  TimestreamDatabaseName:
    Description: Timestream database name
    Value: !Ref TimestreamDatabase
    Export:
      Name: !Sub '${ProjectName}-timestream-db'

  SensorMeasurementsTableName:
    Description: Timestream table for sensor measurements
    Value: !Ref SensorMeasurementsTable
    Export:
      Name: !Sub '${ProjectName}-sensor-table'

  GlueDatabaseName:
    Description: Glue database for marine data catalog
    Value: !Ref GlueDatabase
    Export:
      Name: !Sub '${ProjectName}-glue-db'

  AthenaWorkgroupName:
    Description: Athena workgroup for species queries
    Value: !Ref AthenaWorkgroup
    Export:
      Name: !Sub '${ProjectName}-athena-workgroup'

  SageMakerExecutionRoleArn:
    Description: IAM role for SageMaker
    Value: !GetAtt SageMakerExecutionRole.Arn
    Export:
      Name: !Sub '${ProjectName}-sagemaker-role'

  BatchJobQueueName:
    Description: AWS Batch job queue
    Value: !Ref BatchJobQueue
    Export:
      Name: !Sub '${ProjectName}-batch-queue'

  VPCId:
    Description: VPC ID
    Value: !Ref MarineVPC
    Export:
      Name: !Sub '${ProjectName}-vpc-id'

  PrivateSubnet1Id:
    Description: Private Subnet 1 ID
    Value: !Ref PrivateSubnet1
    Export:
      Name: !Sub '${ProjectName}-private-subnet-1'

  PrivateSubnet2Id:
    Description: Private Subnet 2 ID
    Value: !Ref PrivateSubnet2
    Export:
      Name: !Sub '${ProjectName}-private-subnet-2'
