AWSTemplateFormatVersion: '2010-09-09'
Description: 'Complete CloudFormation template for Smart Grid Optimization system - All 63 Projects'

Parameters:
  ProjectName:
    Type: String
    Default: smart-grid-optimization
    Description: Project name for resource naming
    AllowedPattern: ^[a-z0-9-]{1,63}$
    ConstraintDescription: Must be lowercase alphanumeric and hyphens only

  TimestreamRetentionDays:
    Type: Number
    Default: 730
    Description: Data retention period in days for Timestream
    MinValue: 1
    MaxValue: 3650

  Environment:
    Type: String
    Default: production
    AllowedValues:
      - development
      - staging
      - production

  NotificationEmail:
    Type: String
    Description: Email address for SNS notifications

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Project Configuration
        Parameters:
          - ProjectName
          - Environment
          - NotificationEmail
      - Label:
          default: Data Retention
        Parameters:
          - TimestreamRetentionDays

Resources:
  # ============================================================================
  # VPC INFRASTRUCTURE
  # ============================================================================

  EnergySampleVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-vpc'
        - Key: Environment
          Value: !Ref Environment

  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref EnergySampleVPC
      CidrBlock: 10.0.1.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-public-subnet-1'

  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref EnergySampleVPC
      CidrBlock: 10.0.10.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-private-subnet-1'

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref EnergySampleVPC
      CidrBlock: 10.0.11.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-private-subnet-2'

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-igw'

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref EnergySampleVPC
      InternetGatewayId: !Ref InternetGateway

  EIP:
    Type: AWS::EC2::EIP
    DependsOn: AttachGateway
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-eip'

  NATGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt EIP.AllocationId
      SubnetId: !Ref PublicSubnet1
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-nat-gateway'

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref EnergySampleVPC
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-public-rt'

  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet1
      RouteTableId: !Ref PublicRouteTable

  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref EnergySampleVPC
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-private-rt'

  PrivateRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NATGateway

  PrivateSubnetRouteTableAssociation1:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet1
      RouteTableId: !Ref PrivateRouteTable

  PrivateSubnetRouteTableAssociation2:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet2
      RouteTableId: !Ref PrivateRouteTable

  # Security Groups
  LambdaSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Lambda functions
      VpcId: !Ref EnergySampleVPC
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-lambda-sg'

  BatchSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for AWS Batch compute environments
      VpcId: !Ref EnergySampleVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 0
          ToPort: 65535
          SourceSecurityGroupId: !Ref BatchSecurityGroup
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-batch-sg'

  # S3 VPC Endpoint
  S3Endpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref EnergySampleVPC
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.s3'
      RouteTableIds:
        - !Ref PrivateRouteTable
        - !Ref PublicRouteTable

  # ============================================================================
  # S3 BUCKETS
  # ============================================================================

  SmartMeterDataBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${ProjectName}-smart-meter-data-${AWS::AccountId}'
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-smart-meter-data'

  HistoricalLoadDataBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${ProjectName}-historical-load-${AWS::AccountId}'
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-historical-load'

  WeatherDataBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${ProjectName}-weather-data-${AWS::AccountId}'
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-weather-data'

  ModelsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${ProjectName}-models-${AWS::AccountId}'
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-models'

  OptimizationResultsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${ProjectName}-optimization-results-${AWS::AccountId}'
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-optimization-results'

  # ============================================================================
  # AWS IoT CORE
  # ============================================================================

  SmartMeterIoTRule:
    Type: AWS::IoT::TopicRule
    Properties:
      TopicRulePayload:
        RuleDisabled: false
        Sql: !Sub |
          SELECT *, timestamp() as ts
          FROM '${ProjectName}/meters/+/data'
        Actions:
          - Kinesis:
              RoleArn: !GetAtt IoTKinesisRole.Arn
              StreamName: !Ref GridDataStream

  GridSensorIoTRule:
    Type: AWS::IoT::TopicRule
    Properties:
      TopicRulePayload:
        RuleDisabled: false
        Sql: !Sub |
          SELECT *, timestamp() as ts
          FROM '${ProjectName}/sensors/+/readings'
        Actions:
          - Kinesis:
              RoleArn: !GetAtt IoTKinesisRole.Arn
              StreamName: !Ref GridDataStream

  IoTKinesisRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: iot.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: KinesisPutRecords
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - kinesis:PutRecord
                  - kinesis:PutRecords
                Resource: !GetAtt GridDataStream.Arn

  # ============================================================================
  # KINESIS STREAM
  # ============================================================================

  GridDataStream:
    Type: AWS::Kinesis::Stream
    Properties:
      Name: !Sub '${ProjectName}-grid-data'
      ShardCount: 2
      RetentionPeriod: 24
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-grid-data-stream'

  # ============================================================================
  # TIMESTREAM
  # ============================================================================

  EnergyTimestreamDatabase:
    Type: AWS::Timestream::Database
    Properties:
      DatabaseName: !Sub '${ProjectName}-energy-db'
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-energy-database'

  SmartMeterTable:
    Type: AWS::Timestream::Table
    Properties:
      DatabaseName: !Ref EnergyTimestreamDatabase
      TableName: smart_meter_data
      RetentionProperties:
        MemoryStoreRetentionPeriodInHours: 12
        MagneticStoreRetentionPeriodInDays: !Ref TimestreamRetentionDays
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-smart-meter-table'

  GridSensorsTable:
    Type: AWS::Timestream::Table
    Properties:
      DatabaseName: !Ref EnergyTimestreamDatabase
      TableName: grid_sensors
      RetentionProperties:
        MemoryStoreRetentionPeriodInHours: 12
        MagneticStoreRetentionPeriodInDays: !Ref TimestreamRetentionDays
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-grid-sensors-table'

  # ============================================================================
  # GLUE DATA CATALOG
  # ============================================================================

  EnergyGlueDatabase:
    Type: AWS::Glue::Database
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseInput:
        Name: !Sub '${ProjectName}_energy_catalog'
        Description: Energy data catalog for smart grid optimization

  SmartMeterCrawler:
    Type: AWS::Glue::Crawler
    Properties:
      Name: !Sub '${ProjectName}-smart-meter-crawler'
      Role: !GetAtt GlueCrawlerRole.Arn
      DatabaseName: !Ref EnergyGlueDatabase
      Targets:
        S3Targets:
          - Path: !Sub 's3://${SmartMeterDataBucket}/'
      SchemaChangePolicy:
        UpdateBehavior: UPDATE_IN_DATABASE
        DeleteBehavior: LOG
      Tags:
        Name: !Sub '${ProjectName}-smart-meter-crawler'

  GlueCrawlerRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: glue.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSGlueServiceRole
      Policies:
        - PolicyName: GlueCrawlerS3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                Resource:
                  - !Sub '${SmartMeterDataBucket.Arn}/*'
                  - !Sub '${HistoricalLoadDataBucket.Arn}/*'
              - Effect: Allow
                Action:
                  - s3:ListBucket
                Resource:
                  - !GetAtt SmartMeterDataBucket.Arn
                  - !GetAtt HistoricalLoadDataBucket.Arn

  # ============================================================================
  # ATHENA
  # ============================================================================

  AthenaWorkgroup:
    Type: AWS::Athena::WorkGroup
    Properties:
      Name: !Sub '${ProjectName}-energy-workgroup'
      RecursiveDeleteOption: true
      WorkGroupConfiguration:
        ResultConfigurationUpdates:
          OutputLocation: !Sub 's3://${OptimizationResultsBucket}/athena-results/'
        EnforceWorkGroupConfiguration: true
        PublishCloudWatchMetricsEnabled: true
        BytesScannedCutoffPerQuery: 10737418240
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-athena-workgroup'

  # ============================================================================
  # SNS TOPIC FOR ALERTS
  # ============================================================================

  GridAnomalyTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Sub '${ProjectName}-grid-anomalies'
      DisplayName: Grid Anomaly Alerts
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-grid-anomaly-topic'

  GridAnomalySubscription:
    Type: AWS::SNS::Subscription
    Properties:
      Protocol: email
      TopicArn: !Ref GridAnomalyTopic
      Endpoint: !Ref NotificationEmail

  # ============================================================================
  # LAMBDA EXECUTION ROLE
  # ============================================================================

  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
      Policies:
        - PolicyName: LambdaS3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                Resource:
                  - !Sub '${SmartMeterDataBucket.Arn}/*'
                  - !Sub '${HistoricalLoadDataBucket.Arn}/*'
                  - !Sub '${WeatherDataBucket.Arn}/*'
                  - !Sub '${ModelsBucket.Arn}/*'
                  - !Sub '${OptimizationResultsBucket.Arn}/*'
        - PolicyName: LambdaTimestreamAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - timestream:WriteRecords
                  - timestream:DescribeTable
                Resource: '*'
        - PolicyName: LambdaSNSPublish
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - sns:Publish
                Resource: !Ref GridAnomalyTopic
        - PolicyName: LambdaCloudWatchLogs
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: arn:aws:logs:*:*:*

  # ============================================================================
  # LAMBDA FUNCTIONS
  # ============================================================================

  LoadForecastingFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-load-forecasting'
      Runtime: python3.11
      Handler: index.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 300
      MemorySize: 1024
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
      Environment:
        Variables:
          MODELS_BUCKET: !Ref ModelsBucket
          RESULTS_BUCKET: !Ref OptimizationResultsBucket
          TIMESTREAM_DB: !Ref EnergyTimestreamDatabase
          TIMESTREAM_TABLE: !Ref SmartMeterTable
      Code:
        ZipFile: |
          import json
          import boto3
          import numpy as np
          from datetime import datetime

          def lambda_handler(event, context):
              """Load forecasting using LSTM model for real-time inference"""
              print(f"Load forecasting invoked: {json.dumps(event)}")

              # Placeholder for LSTM model inference
              forecast = {
                  'timestamp': datetime.utcnow().isoformat(),
                  'predicted_load_mw': np.random.uniform(100, 500),
                  'confidence_interval': [95, 105]
              }

              return {
                  'statusCode': 200,
                  'body': json.dumps(forecast)
              }

  AnomalyDetectionFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-anomaly-detection'
      Runtime: python3.11
      Handler: index.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 300
      MemorySize: 1024
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
      Environment:
        Variables:
          ANOMALY_TOPIC: !Ref GridAnomalyTopic
          TIMESTREAM_DB: !Ref EnergyTimestreamDatabase
          TIMESTREAM_TABLE: !Ref GridSensorsTable
      Code:
        ZipFile: |
          import json
          import boto3
          from datetime import datetime

          sns = boto3.client('sns')

          def lambda_handler(event, context):
              """Anomaly detection for grid equipment"""
              print(f"Anomaly detection invoked: {json.dumps(event)}")

              anomalies = []
              for record in event.get('Records', []):
                  voltage = float(record.get('voltage', 240))
                  if voltage < 200 or voltage > 260:
                      anomalies.append({
                          'type': 'voltage_anomaly',
                          'value': voltage,
                          'timestamp': datetime.utcnow().isoformat()
                      })

                      sns.publish(
                          TopicArn=context.environment_variables['ANOMALY_TOPIC'],
                          Subject='Grid Voltage Anomaly Detected',
                          Message=json.dumps(anomalies[0])
                      )

              return {
                  'statusCode': 200,
                  'anomaliesDetected': len(anomalies),
                  'body': json.dumps(anomalies)
              }

  PriceOptimizationFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-price-optimization'
      Runtime: python3.11
      Handler: index.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 300
      MemorySize: 1024
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
      Environment:
        Variables:
          RESULTS_BUCKET: !Ref OptimizationResultsBucket
      Code:
        ZipFile: |
          import json
          import boto3
          from datetime import datetime

          def lambda_handler(event, context):
              """Price optimization for battery and EV charging"""
              print(f"Price optimization invoked: {json.dumps(event)}")

              optimization_result = {
                  'timestamp': datetime.utcnow().isoformat(),
                  'battery_charge_price': 45.50,
                  'battery_discharge_price': 62.75,
                  'ev_charging_price': 0.28,
                  'optimization_horizon_hours': 24
              }

              return {
                  'statusCode': 200,
                  'body': json.dumps(optimization_result)
              }

  # ============================================================================
  # SAGEMAKER ROLE
  # ============================================================================

  SageMakerExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: sagemaker.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSageMakerFullAccess
      Policies:
        - PolicyName: SageMakerS3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                  - s3:ListBucket
                Resource:
                  - !Sub '${SmartMeterDataBucket.Arn}'
                  - !Sub '${SmartMeterDataBucket.Arn}/*'
                  - !Sub '${HistoricalLoadDataBucket.Arn}'
                  - !Sub '${HistoricalLoadDataBucket.Arn}/*'
                  - !Sub '${ModelsBucket.Arn}'
                  - !Sub '${ModelsBucket.Arn}/*'

  # ============================================================================
  # AWS BATCH
  # ============================================================================

  BatchServiceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: batch.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSBatchServiceRole

  BatchComputeRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonEC2ContainerServiceforEC2Role
      Policies:
        - PolicyName: BatchS3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:ListBucket
                Resource:
                  - !Sub '${OptimizationResultsBucket.Arn}'
                  - !Sub '${OptimizationResultsBucket.Arn}/*'
                  - !Sub '${HistoricalLoadDataBucket.Arn}'
                  - !Sub '${HistoricalLoadDataBucket.Arn}/*'

  BatchComputeInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref BatchComputeRole

  BatchComputeEnvironment:
    Type: AWS::Batch::ComputeEnvironment
    Properties:
      ComputeEnvironmentName: !Sub '${ProjectName}-optimization-env'
      Type: MANAGED
      State: ENABLED
      ComputeResources:
        Type: EC2
        MinvCpus: 0
        MaxvCpus: 256
        DesiredvCpus: 4
        InstanceTypes:
          - c5.xlarge
          - c5.2xlarge
          - c5.4xlarge
        Subnets:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
        SecurityGroupIds:
          - !Ref BatchSecurityGroup
        InstanceRole: !GetAtt BatchComputeInstanceProfile.Arn
      ServiceRole: !GetAtt BatchServiceRole.Arn

  BatchJobQueue:
    Type: AWS::Batch::JobQueue
    Properties:
      JobQueueName: !Sub '${ProjectName}-optimization-queue'
      State: ENABLED
      Priority: 1
      ComputeEnvironmentOrder:
        - Order: 1
          ComputeEnvironment: !Ref BatchComputeEnvironment

  OptimalPowerFlowJobDefinition:
    Type: AWS::Batch::JobDefinition
    Properties:
      JobDefinitionName: !Sub '${ProjectName}-opf-job'
      Type: container
      ContainerProperties:
        Image: !Sub '${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/energy-optimization:latest'
        Vcpus: 4
        Memory: 8192
        Environment:
          - Name: RESULTS_BUCKET
            Value: !Ref OptimizationResultsBucket
          - Name: OPTIMIZATION_TYPE
            Value: OPF
        JobRoleArn: !GetAtt BatchComputeRole.Arn

  UnitCommitmentJobDefinition:
    Type: AWS::Batch::JobDefinition
    Properties:
      JobDefinitionName: !Sub '${ProjectName}-unit-commitment-job'
      Type: container
      ContainerProperties:
        Image: !Sub '${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/energy-optimization:latest'
        Vcpus: 4
        Memory: 8192
        Environment:
          - Name: RESULTS_BUCKET
            Value: !Ref OptimizationResultsBucket
          - Name: OPTIMIZATION_TYPE
            Value: UNIT_COMMITMENT
        JobRoleArn: !GetAtt BatchComputeRole.Arn

Outputs:
  SmartMeterDataBucketName:
    Description: S3 bucket for smart meter AMI data
    Value: !Ref SmartMeterDataBucket
    Export:
      Name: !Sub '${ProjectName}-smart-meter-bucket'

  HistoricalLoadBucketName:
    Description: S3 bucket for historical load data
    Value: !Ref HistoricalLoadDataBucket
    Export:
      Name: !Sub '${ProjectName}-historical-load-bucket'

  WeatherDataBucketName:
    Description: S3 bucket for weather data
    Value: !Ref WeatherDataBucket
    Export:
      Name: !Sub '${ProjectName}-weather-data-bucket'

  ModelsBucketName:
    Description: S3 bucket for ML models
    Value: !Ref ModelsBucket
    Export:
      Name: !Sub '${ProjectName}-models-bucket'

  OptimizationResultsBucketName:
    Description: S3 bucket for optimization results
    Value: !Ref OptimizationResultsBucket
    Export:
      Name: !Sub '${ProjectName}-optimization-results-bucket'

  GridDataStreamName:
    Description: Kinesis stream for real-time grid data
    Value: !Ref GridDataStream
    Export:
      Name: !Sub '${ProjectName}-grid-data-stream'

  TimestreamDatabaseName:
    Description: Timestream database for energy time series
    Value: !Ref EnergyTimestreamDatabase
    Export:
      Name: !Sub '${ProjectName}-timestream-db'

  SmartMeterTableName:
    Description: Timestream table for smart meter data
    Value: !Ref SmartMeterTable
    Export:
      Name: !Sub '${ProjectName}-smart-meter-table'

  GridSensorsTableName:
    Description: Timestream table for grid sensors
    Value: !Ref GridSensorsTable
    Export:
      Name: !Sub '${ProjectName}-grid-sensors-table'

  LoadForecastingFunctionArn:
    Description: ARN of load forecasting Lambda function
    Value: !GetAtt LoadForecastingFunction.Arn
    Export:
      Name: !Sub '${ProjectName}-load-forecasting-function'

  AnomalyDetectionFunctionArn:
    Description: ARN of anomaly detection Lambda function
    Value: !GetAtt AnomalyDetectionFunction.Arn
    Export:
      Name: !Sub '${ProjectName}-anomaly-detection-function'

  PriceOptimizationFunctionArn:
    Description: ARN of price optimization Lambda function
    Value: !GetAtt PriceOptimizationFunction.Arn
    Export:
      Name: !Sub '${ProjectName}-price-optimization-function'

  BatchComputeEnvironmentArn:
    Description: ARN of Batch compute environment
    Value: !Ref BatchComputeEnvironment
    Export:
      Name: !Sub '${ProjectName}-batch-compute-env'

  BatchJobQueueArn:
    Description: ARN of Batch job queue
    Value: !Ref BatchJobQueue
    Export:
      Name: !Sub '${ProjectName}-batch-job-queue'

  GridAnomalyTopicArn:
    Description: ARN of SNS topic for grid anomalies
    Value: !Ref GridAnomalyTopic
    Export:
      Name: !Sub '${ProjectName}-anomaly-topic'

  VPCId:
    Description: VPC ID for the energy system infrastructure
    Value: !Ref EnergySampleVPC
    Export:
      Name: !Sub '${ProjectName}-vpc'

  PrivateSubnet1Id:
    Description: Private subnet 1 ID
    Value: !Ref PrivateSubnet1
    Export:
      Name: !Sub '${ProjectName}-private-subnet-1'

  PrivateSubnet2Id:
    Description: Private subnet 2 ID
    Value: !Ref PrivateSubnet2
    Export:
      Name: !Sub '${ProjectName}-private-subnet-2'

  GlueDatabaseName:
    Description: Glue database for energy data catalog
    Value: !Ref EnergyGlueDatabase
    Export:
      Name: !Sub '${ProjectName}-glue-database'

  AthenaWorkgroupName:
    Description: Athena workgroup for SQL queries
    Value: !Ref AthenaWorkgroup
    Export:
      Name: !Sub '${ProjectName}-athena-workgroup'

  SageMakerRoleArn:
    Description: SageMaker execution role for LSTM training
    Value: !GetAtt SageMakerExecutionRole.Arn
    Export:
      Name: !Sub '${ProjectName}-sagemaker-role'
